% !TEX root=main.tex


%% Typing %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationT}
  {\Gamma,\Sigma \infers e : \tau}

\newrule{T-ConstBool}
  {c\in B}
  {\Gamma,\Sigma\infers c : \Bool}

  \newrule{T-ConstInt}
    {c\in I}
    {\Gamma,\Sigma\infers c : \Int}

    \newrule{T-ConstString}
      {c\in S}
      {\Gamma,\Sigma\infers c : \String}

      \newrule{T-Unit}
        { }
        {\Gamma,\Sigma\infers \unit : \Unit}
\newrule{T-Var}
  {x:\tau\in\Gamma}
  {\Gamma,\Sigma\infers x:\tau}


\newrule{T-Abs}
  {\Gamma[x:\tau_1] ,\Sigma \infers e:\tau_2}
  {\Gamma,\Sigma \infers \lambda x : \tau_1 . e :\tau_1 \to \tau_2}

\newrule{T-App}
  {\Gamma,\Sigma \infers e_1:\tau_1\to\tau_2 \Quad
   \Gamma,\Sigma \infers e_2:\tau_1}
  {\Gamma,\Sigma \infers e_1 e_2 :\tau_2}


\newrule{T-If}
  {\Gamma,\Sigma \infers e_1:\Bool \Quad
   \Gamma,\Sigma \infers e_2:\tau \Quad
   \Gamma,\Sigma \infers e_3:\tau}
  {\Gamma,\Sigma \infers \If{e_1}{e_2}{e_3}:\tau}


\newrule{T-Pair}
    {\Gamma,\Sigma \infers e_1 : \tau_1  \Quad
     \Gamma,\Sigma \infers e_2 : \tau_2}
    {\Gamma,\Sigma \infers \tuple{e_1, e_2} :\tau_1 \times \tau_2}

\newrule{T-First}
  {\Gamma,\Sigma\infers e_1:\tau}
  {\Gamma,\Sigma\infers \Fst \tuple{e_1,e_2}:\tau}

  \newrule{T-Second}
    {\Gamma,\Sigma\infers e_2:\tau}
    {\Gamma,\Sigma\infers \Snd \tuple{e_1,e_2}:\tau}

%%%%%
\newrule{T-ListEmpty}
  { }
  {\Gamma,\Sigma\infers [\ ]_\beta : \List\beta}

\newrule{T-ListCons}
  {\Gamma,\Sigma\infers e_1:\beta \Quad
   \Gamma,\Sigma\infers e_2:\List\beta}
  {\Gamma,\Sigma\infers e_1 :: e_2 : \List \beta}

\newrule{T-ListHead}
  {\Gamma,\Sigma\infers e:\List\beta}
  {\Gamma,\Sigma\infers \Head e:\beta}

\newrule{T-ListTail}
    {\Gamma,\Sigma\infers e:\List\beta}
    {\Gamma,\Sigma\infers \Tail e:\List\beta}

%%%%%


\newrule{T-Ref}
  {\Gamma,\Sigma \infers e:\beta}
  {\Gamma,\Sigma \infers \Ref e :\Reference \beta}

\newrule{T-Deref}
  {\Gamma,\Sigma \infers e:\Reference \beta}
  {\Gamma,\Sigma\infers\ !e:\beta}

\newrule{T-Assign}
  {\Gamma,\Sigma\infers e_1:\Reference \beta \Quad
   \Gamma,\Sigma\infers e_2:\beta}
  {\Gamma,\Sigma\infers e_1 := e_2:\Unit}

\newrule{T-Loc}
  {\Sigma(l) = \beta}
  {\Gamma,\Sigma\infers l:\Reference \beta}


\newrule{T-Edit}
  {\Gamma,\Sigma \infers e : \tau}
  {\Gamma,\Sigma \infers \Edit e : \Task \tau}

\newrule{T-Enter}
  {}
  {\Gamma,\Sigma \infers \Enter \tau : \Task \tau}

\newrule{T-Update}
  {\Gamma,\Sigma \infers e : \Reference \beta}
  {\Gamma,\Sigma \infers \Update e : \Task \beta}


\newrule{T-Fail}
  {}
  {\Gamma,\Sigma \infers \Fail : \Task \tau}


\newrule{T-Then}
  {\upon{\Gamma,\Sigma \infers e_1 : \Task \tau_1}
   {\Gamma,\Sigma \infers e_2 : \tau_1 \to \Task \tau_2}}
  {\Gamma,\Sigma \infers e_1 \Then e_2 : \Task \tau_2}


\newrule{T-Next}
  {\upon{\Gamma,\Sigma \infers e_1 : \Task \tau_1}
   {\Gamma,\Sigma \infers e_2 : \tau_1 \to \Task \tau_2}}
  {\Gamma,\Sigma \infers e_1 \Next e_2 : \Task \tau_2}


\newrule{T-And}
  {\Gamma,\Sigma \infers e_1 : \Task \tau_1 \Quad
   \Gamma,\Sigma \infers e_2 : \Task \tau_2}
  {\Gamma,\Sigma \infers e_1 \And e_2 : \Task\,(\tau_1 \times \tau_2)}


\newrule{T-Or}
  {\upon{\Gamma,\Sigma \infers e_1 : \Task \tau}
   {\Gamma,\Sigma \infers e_2 : \Task \tau}}
  {\Gamma,\Sigma \infers e_1 \Or e_2 : \Task \tau}


\newrule{T-Xor}
  {\upon{\Gamma,\Sigma \infers e_1 : \Task \tau}
   {\Gamma,\Sigma \infers e_2 : \Task \tau}}
  {\Gamma,\Sigma \infers e_1 \Xor e_2 : \Task \tau}

%% Evaluation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newrule{E-Value}
  {}
  {v,\bar{\sigma}\bar{\eval} v,\bar{\sigma}}


\newrule{E-App}
  {e_1,\bar{\sigma}\bar{\eval} \lambda x:\tau.\bar{e_1'},\bar{\sigma'}\Quad
   e_2,\bar{\sigma'}\bar{\eval} \bar{v_2},\bar{\sigma''}\Quad
   e_1'[x\mapsto v_2],\bar{\sigma''}\bar{\eval} \bar{v_1},\bar{\sigma'''}}
  {e_1 e_2,\bar{\sigma} \bar{\eval} \bar{v_1},\bar{\sigma'''}}


\newrule{E-IfTrue}
  {e_1,\bar{\sigma}\bar{\eval} \True,\bar{\sigma'}\Quad
   e_2,\bar{\sigma'}\bar{\eval} \bar{v_2},\bar{\sigma''}}
  {\If{e_1}{e_2}{e_3},\bar{\sigma}\bar{\eval} \bar{v_2},\bar{\sigma''}}

\newrule{E-IfFalse}
  {e_1,\bar{\sigma}\bar{\eval} \bar{v_1},\bar{\sigma'} \Quad
   e_3,\bar{\sigma'}\bar{\eval} \bar{v_3},\bar{\sigma''}}
  {\If{e_1}{e_2}{e_3},\bar{\sigma}\bar{\eval} \bar{v_3},\bar{\sigma''}}


\newrule{E-Pair}
  {e_1,\bar{\sigma}\bar{\eval} \bar{v_1},\bar{\sigma'} \Quad
   e_2,\bar{\sigma'}\bar{\eval} \bar{v_2},\bar{\sigma''}}
  {\tuple{e_1,e_2},\bar{\sigma}\bar{\eval}\tuple{\bar{v_1},\bar{v_2}},\bar{\sigma''}}

\newrule{E-First}
  {e_1,\bar{\sigma}\bar{\eval}\bar{v_1},\bar{\sigma'}}
  {\Fst\tuple{e_1,e_2},\bar{\sigma}\bar{\eval}\bar{v_1},\bar{\sigma'}}

\newrule{E-Second}
  {e_2,\bar{\sigma}\bar{\eval}\bar{v_2},\bar{\sigma'}}
  {\Snd\tuple{e_1,e_2},\bar{\sigma}\bar{\eval} \bar{v_2},\bar{\sigma'} }

%%%%%%%%%

\newrule{E-Cons}
  {e_1,\bar{\sigma}\bar{\eval}\bar{v_1},\bar{\sigma'}\Quad
   e_2,\bar{\sigma'}\bar{\eval}\bar{v_2},\bar{\sigma''}}
  {e_1 :: e_2,\bar{\sigma}\bar{\eval}\bar{v_1}::\bar{v_2},\bar{\sigma''}}

\newrule{E-Head}
  {e,\bar{\sigma}\bar{\eval} \bar{v_1}::\bar{v_2},\bar{\sigma'}}
  {\Head e,\bar{\sigma}\bar{\eval}\bar{v_1},\bar{\sigma'}}

\newrule{E-Tail}
{e,\bar{\sigma}\bar{\eval} \bar{v_1}::\bar{v_2},\bar{\sigma'}}
{\Tail e,\bar{\sigma}\bar{\eval}\bar{v_2},\bar{\sigma'}}

%%%%%%


\newrule{E-Ref}
  {e,\bar{\sigma}\bar{\eval} \bar{v},\bar{\sigma'} \Quad
   l\not\in Dom(\bar{\sigma'})}
  {\Ref e,\bar{\sigma}\bar{\eval} l,\bar{\sigma'}[l\mapsto \bar{v}]}

\newrule{E-Deref}
  {e,\bar{\sigma}\bar{\eval} l,\bar{\sigma'}}
  {!e,\bar{\sigma}\bar{\eval} \bar{\sigma'}(l),\bar{\sigma'}}

\newrule{E-Assign}
  {e_1,\bar{\sigma}\bar{\eval} l,\bar{\sigma'} \Quad
   e_2,\bar{\sigma'}\bar{\eval} \bar{v_2},\bar{\sigma''}}
  {e_1:=e_2,\bar{\sigma}\bar{\eval} \unit,\bar{\sigma''}[l\mapsto \bar{v_2}]}

\newrule{E-Edit}
  {e,\bar{\sigma} \bar{\eval} \bar{v},\bar{\sigma'}}
  {\Edit e , \bar{\sigma}\bar{\eval} \Edit \bar{v},\bar{\sigma'}}

\newrule{E-Enter}
  {}
  {\Enter \tau,\bar{\sigma} \bar{\eval} \Enter \tau,\bar{\sigma}}

\newrule{E-Update}
  {e,\bar{\sigma}\bar{\eval} l,\bar{\sigma'}}
  {\Update e ,\bar{\sigma}\bar{\eval} \Update l,\bar{\sigma'}}


\newrule{E-Fail}
  {}
  {\Fail,\bar{\sigma} \bar{\eval} \Fail,\bar{\sigma}}


\newrule{E-Then}
  {e_1 ,\bar{\sigma}\bar{\eval} \bar{t_1},\bar{\sigma'}}
  {e_1 \Then e_2,\bar{\sigma}\bar{\eval}\bar{t_1} \Then e_2,\bar{\sigma'}}

\newrule{E-Next}
  {e_1 ,\bar{\sigma}\bar{\eval} \bar{t_1},\bar{\sigma'}}
  {e_1 \Next e_2 ,\bar{\sigma}\bar{\eval} \bar{t_1} \Next e_2,\bar{\sigma'}}


\newrule{E-And}
  {e_1 ,\bar{\sigma}\bar{\eval}\bar{ t_1 },\bar{\sigma'}\Quad
   e_2 ,\bar{\sigma'}\bar{\eval} \bar{t_2},\bar{\sigma''}}
  {e_1 \And e_2 ,\bar{\sigma}\bar{\eval}\bar{ t_1} \And \bar{t_2},\bar{\sigma''}}


\newrule{E-Or}
  {e_1 ,\bar{\sigma}\bar{\eval}\bar{ t_1} ,\bar{\sigma'}\Quad
   e_2 ,\bar{\sigma'}\bar{\eval} \bar{t_2},\bar{\sigma''}}
  {e_1 \Or e_2 ,\bar{\sigma}\bar{\eval} \bar{t_1} \Or \bar{t_2},\bar{\sigma''}}

\newrule{E-Xor}
  {}
  {e_1 \Xor e_2 ,\bar{\sigma}\bar{\eval} e_1 \Xor e_2,\bar{\sigma}}

%% Normalisation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newrule{S-Edit}
  { }
  {\Edit v,\bar{\sigma} \bar{\stride} \Edit v,\bar{\sigma}}

\newrule{S-Fill}
  { }
  {\Enter \tau,\bar{\sigma} \bar{\stride} \Enter \tau,\bar{\sigma}}

\newrule{S-Update}
  { }
  {\Update l,\bar{\sigma} \bar{\stride} \Update l,\bar{\sigma}}


\newrule{S-Fail}
  { }
  {\Fail,\bar{\sigma} \bar{\stride} \Fail,\bar{\sigma}}


\newrule{S-ThenStay}
  {t_1,\bar{\sigma} \bar{\stride} \bar{t_1'},\bar{\sigma'}}
  {t_1 \Then e_2,\bar{\sigma} \bar{\stride} \bar{t_1'} \Then e_2,\bar{\sigma'}}
  [\Value(\bar{t_1'},\bar{\sigma'}) = \bot]

\newrule{S-ThenFail}
  {t_1,\bar{\sigma} \bar{\stride} \bar{t_1'},\bar{\sigma'} \Quad
   e_2\ \bar{v_1},\bar{\sigma'} \bar{\eval} \bar{t_2},\bar{\sigma''}}
  {t_1 \Then e_2,\bar{\sigma} \bar{\stride} \bar{t_1'} \Then e_2,\bar{\sigma'}}
  [\Value(\bar{t_1'},\bar{\sigma'}) = \bar{v_1} \land \Failing(\bar{t_2},\bar{\sigma''})]

\newrule{S-ThenCont}
  {t_1,\bar{\sigma} \bar{\stride} \bar{t_1'},\bar{\sigma'}  \Quad
   e_2\ \bar{v_1},\bar{\sigma'} \bar{\eval} \bar{t_2 },\bar{\sigma''}}
  {t_1 \Then e_2,\bar{\sigma} \bar{\stride} \bar{t_2},\bar{\sigma''}}
  [\Value(\bar{t_1'},\bar{\sigma'}) = \bar{v_1} \land \lnot\Failing(\bar{t_2},\bar{\sigma''})]

\newrule{S-Next}
  {t_1,\bar{\sigma} \bar{\stride} \bar{t_1'},\bar{\sigma'}}
  {t_1 \Next e_2,\bar{\sigma} \bar{\stride} \bar{t_1'} \Next e_2,\bar{\sigma'}}


\newrule{S-And}
  {t_1,\bar{\sigma}  \bar{\stride} \bar{t_1'},\bar{\sigma'}  \Quad
   t_2,\bar{\sigma'} \bar{\stride} \bar{t_2'},\bar{\sigma''}}
  {t_1 \And t_2,\bar{\sigma} \bar{\stride} \bar{t_1'} \And \bar{t_2'},\bar{\sigma''}}


\newrule{S-OrLeft}
  {t_1,\bar{\sigma}  \bar{\stride} \bar{t_1'},\bar{\sigma'}}
  {t_1 \Or t_2,\bar{\sigma} \bar{\stride} \bar{t_1'},\bar{\sigma'}}
  [\Value(\bar{t_1'},\bar{\sigma'}) = \bar{v_1}]

\newrule{S-OrRight}
  {t_1,\bar{\sigma}  \bar{\stride} \bar{t_1'},\bar{\sigma'}  \Quad
   t_2,\bar{\sigma'} \bar{\stride} \bar{t_2'},\bar{\sigma''}}
  {t_1 \Or t_2,\bar{\sigma} \bar{\stride} \bar{t_2'},\bar{\sigma''}}
  [\Value(\bar{t_1'},\bar{\sigma'}) = \bot \land \Value(\bar{t_2'},\bar{\sigma''}) = \bar{v_2}]

\newrule{S-OrNone}
  {t_1,\bar{\sigma}  \bar{\stride }\bar{t_1'},\bar{\sigma'}  \Quad
   t_2,\bar{\sigma' }\bar{\stride} \bar{t_2'},\bar{\sigma''}}
  {t_1 \Or t_2,\bar{\sigma} \bar{\stride} \bar{t_1'} \Or \bar{t_2'},\bar{\sigma''}}
  [\Value(\bar{t_1'},\bar{\sigma'}) = \bot \land \Value(\bar{t_2'},\bar{\sigma''}) = \bot]


\newrule{S-Xor}
  { }
  {e_1 \Xor e_2,\bar{\sigma} \bar{\stride} e_1 \Xor e_2,\bar{\sigma}}

\newrule{S-Eval}
    {e,\bar{\sigma} \bar{\eval} \bar{e'},\bar{\sigma'}  \Quad
     e',\bar{\sigma'} \bar{\stride} \bar{e''},\bar{\sigma''}}
    {e,\bar{\sigma} \bar{\stride} \bar{e''},\bar{\sigma''}}
    [e \neq \bar{e'}]

%% Normalisation %%

\newrule{N-Done}
    {e,\bar{\sigma} \bar{\eval} \bar{t},\bar{\sigma'} \Quad
     \bar{t},\bar{\sigma'} \bar{\stride} \bar{t'},\bar{\sigma''}}
    {e,\bar{\sigma} \bar{\normalise} \bar{t},\bar{\sigma'}}
    [\bar{\sigma'}=\bar{\sigma''} \land \bar{t}=\bar{t'}]

\newrule{N-Repeat}
    {e,\bar{\sigma} \bar{\eval} \bar{t},\bar{\sigma'}  \Quad
     \bar{t},\bar{\sigma'} \bar{\stride} \bar{t'},\bar{\sigma''}  \Quad
     \bar{t'},\bar{\sigma''} \bar{\normalise} \bar{t''},\bar{\sigma'''}}
    {e,\bar{\sigma} \bar{\normalise} \bar{t''},\bar{\sigma'''}}
    [\bar{\sigma'}\neq \bar{\sigma''}\vee \bar{t}\neq \bar{t'}]



%% Handling %%


\newrule{H-Change}
  { }
  {\Edit v,\bar{\sigma} \xrightarrow[]{v'} \Edit v',\bar{\sigma}}
  [v,v':\tau]

\newrule{H-Empty}
  { }
  {\Edit v,\sigma \handle{\Empty} \Enter \tau,\sigma,\True}
  [v : \tau]

\newrule{H-Fill}
  { }
  {\Enter \tau,\bar{\sigma} \xrightarrow[]{v} \Edit v,\bar{\sigma}}
  [v:\tau]

\newrule{H-Update}
  { }
  {\Update l,\bar{\sigma} \xrightarrow[]{v} \Update l,\bar{\sigma}[l \mapsto v]}
  [\sigma(l),v:\tau]

\newrule{H-PassThen}
  {t_1,\sigma \xrightarrow[]{j} t_1',\sigma'}
  {t_1 \Then e_2,\sigma \xrightarrow[]{j} t_1' \Then e_2,\sigma'}

\newrule{H-PassNext}
  {t_1,\sigma \xrightarrow[]{j} t_1',\sigma'}
  {t_1 \Next e_2,\sigma \xrightarrow[]{j} t_1' \Next e_2,\sigma'}

\newrule{H-Next}
  {e_2\ \bar{v_1},\sigma \bar{\normalise} \bar{t_2},\bar{\sigma'}}
  {t_1 \Next e_2,\sigma \xrightarrow[]{\Continue} \bar{t_2},\bar{\sigma'}}
  [\Value{(t_1,\sigma)} = \bar{v_1} \land \neg\Failing{(\bar{t_2},\bar{\sigma'})}]


\newrule{H-FirstAnd}
  {t_1,\sigma \xrightarrow[]{j} \bar{t_1'},\bar{\sigma'}}
  {t_1 \And t_2,\sigma \xrightarrow[]{\First j} \bar{t_1'} \And t_2,\bar{\sigma'}}

\newrule{H-SecondAnd}
  {t_2,\sigma \xrightarrow[]{j} \bar{t_2'},\bar{\sigma'}}
  {t_1 \And t_2,\sigma \xrightarrow[]{\Second j} t_1 \And \bar{t_2'},\bar{\sigma'}}


\newrule{H-FirstOr}
  {t_1,\sigma \xrightarrow[]{j} \bar{t_1'},\bar{\sigma'}}
  {t_1 \Or t_2,\sigma \xrightarrow[]{\First j} \bar{t_1'} \Or t_2,\bar{\sigma'}}

\newrule{H-SecondOr}
  {t_2,\sigma \xrightarrow[]{j} \bar{t_2'},\bar{\sigma'} }
  {t_1 \Or t_2,\sigma \xrightarrow[]{\Second j} t_1 \Or \bar{t_2'},\bar{\sigma'}}


\newrule{H-PickLeft}
  {e_1,\sigma \normalise \bar{t_1},\bar{\sigma'}}
  {e_1 \Xor e_2,\sigma \xrightarrow[]{\Left} \bar{t_1},\bar{\sigma'}}
  [\neg\Failing(\bar{t_1},\bar{\sigma'})]

\newrule{H-PickRight}
  {e_2,\sigma \bar{\normalise} \bar{t_2},\bar{\sigma'}}
  {e_1 \Xor e_2,\sigma \xrightarrow[]{\Right} \bar{t_2},\bar{\sigma'}}
  [\neg\Failing(\bar{t_2},\bar{\sigma'})]



%% Driving %%


\newrule{I-Handle}
  {t,\sigma \xrightarrow[]{j} \bar{t'},\bar{\sigma'} \Quad
   \bar{t'},\bar{\sigma'} \bar{\normalise} \bar{t''},\bar{\sigma''}}
  {t,\sigma \xRightarrow[]{j} \bar{t''},\bar{\sigma''}}
