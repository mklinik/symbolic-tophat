% !TEX root=main.tex


%% Helpers %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newif\ifstateful
\statefulfalse
\newmacro{st}[2][1]
  {\ifthenelse{\isempty{#1}}
    {\ifstateful{,\:s#2}\else{}\fi}
    {\ifstateful{,\:[#1]s#2}\else{}\fi}}
\newmacro{St}[1]
  {\ifstateful{,\:\Sigma#1}\else{}\fi}


%% Evaluation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationE}
  {e,s \symeval v,s'}


\newrule{Sym-E-Value}
  {}
  {v,s,pr\symeval v,s,pr}


\newrule{Sym-E-App}
  {e_1,s,pr\symeval \lambda x:\tau.e_1',s',pr' \Quad
   e_2,s',pr'\symeval v_2,s'',pr'' \Quad
   e_1'[x\mapsto v_2],s'',pr''\symeval v_1,s''',pr'''}
  {e_1 e_2,s,pr \symeval v_1,s''',pr'''}


\newrule{Sym-E-IfTrue}
  {e_1,s,pr\symeval \bar{v},s',pr' \Quad
   pr'\wedge \bar{v} \text{ SAT}\Quad
   e_2,s',pr'\wedge\bar{v}\symeval v,s'',pr''}
  {\If{e_1}{e_2}{e_3},s,pr\symeval v,s'',pr''}

\newrule{Sym-E-IfFalse}
  {e_1,s\symeval \False,s' \Quad
   e_3,s'\symeval v,s''}
  {\If{e_1}{e_2}{e_3},s\symeval v,s''}


\newrule{Sym-E-Pair}
  {e_1,s\symeval v_1,s' \Quad
   e_2,s'\symeval v_2,s''}
  {\tuple{e_1,e_2},s\symeval\tuple{v_1,v_2},s''}


\newrule{Sym-E-Ref}
  {e,s\symeval v,s' \Quad
   l\not\in Dom(s')}
  {\Ref e,s\symeval l,s'[l\mapsto v]}

\newrule{Sym-E-Deref}
  {e,s\symeval l,s'}
  {!e,s\symeval s'(l),s'}

\newrule{Sym-E-Assign}
  {e_1,s\symeval l,s' \Quad
   e_2,s'\symeval v_2,s''}
  {e_1:=e_2,s\symeval \unit,s''[l\mapsto v_2]}

\newrule{Sym-E-Edit}
  {e,s \symeval v,s'}
  {\Edit e , s\symeval \Edit v,s'}

\newrule{Sym-E-Enter}
  {}
  {\Enter \tau,s \symeval \Enter \tau,s}

\newrule{Sym-E-Update}
  {e,s\symeval l,s'}
  {\Update e ,s\symeval \Update l,s'}


\newrule{Sym-E-Fail}
  {}
  {\Fail,s \symeval \Fail,s}


\newrule{Sym-E-Then}
  {e_1 ,s\symeval t_1,s'}
  {e_1 \Then e_2,s \symeval t_1 \Then e_2,s'}

\newrule{Sym-E-Next}
  {e_1 ,s\symeval t_1,s'}
  {e_1 \Next e_2 ,s\symeval t_1 \Next e_2,s'}


\newrule{Sym-E-And}
  {e_1 ,s\symeval t_1 ,s' \Quad
   e_2 ,s'\symeval t_2,s''}
  {e_1 \And e_2 ,s\symeval t_1 \And t_2,s''}


\newrule{Sym-E-Or}
  {e_1 ,s\symeval t_1 ,s' \Quad
   e_2 ,s'\symeval t_2,s''}
  {e_1 \Or e_2 ,s\symeval t_1 \Or t_2,s''}

\newrule{Sym-E-Xor}
  {}
  {e_1 \Xor e_2 ,s\symeval e_1 \Xor e_2,s}

%% Normalisation %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\newmacro{RelationS}
  {t,s,p \symstride t',s',p'}


\newrule{Sym-S-Edit}
  { }
  {\Edit v,s \symstride \Edit v,s}

\newrule{Sym-S-Fill}
  { }
  {\Enter \tau,s \symstride \Enter \tau,s}

\newrule{Sym-S-Update}
  { }
  {\Update l,s \symstride \Update l,s}


\newrule{Sym-S-Fail}
  { }
  {\Fail,s \symstride \Fail,s}


\newrule{Sym-S-ThenStay}
  {t_1,s \symstride t_1',s'}
  {t_1 \Then e_2,s \symstride t_1' \Then e_2,s'}
  [\Value(t_1',s') = \bot]

\newrule{Sym-S-ThenFail}
  {t_1,s \symstride t_1',s'  \Quad
   e_2\ v_1,s' \symeval t_2,s''}
  {t_1 \Then e_2,s \symstride t_1' \Then e_2,s'}
  [\Value(t_1',s') = v_1 \land \Failing(t_2,s'')]

\newrule{Sym-S-ThenCont}
  {t_1,s \symstride t_1',s'  \Quad
   e_2\ v_1,s' \symeval t_2 ,s''}
   % t_2,s'' \stride t_2',s'''}
  {t_1 \Then e_2,s \symstride t_2,s''}
  [\Value(t_1',s') = v_1 \land \lnot\Failing(t_2,s'')]

\newrule{Sym-S-Next}
  {t_1,s \symstride t_1',s'}
  {t_1 \Next e_2,s \symstride t_1' \Next e_2,s'}


\newrule{Sym-S-And}
  {t_1,s  \symstride t_1',s'  \Quad
   t_2,s' \symstride t_2',s''}
  {t_1 \And t_2,s \symstride t_1' \And t_2',s''}


\newrule{Sym-S-OrLeft}
  {t_1,s  \symstride t_1',s'}
  {t_1 \Or t_2,s \symstride t_1',s'}
  [\Value(t_1',s') = v_1]

\newrule{Sym-S-OrRight}
  {t_1,s  \symstride t_1',s'  \Quad
   t_2,s' \symstride t_2',s''}
  {t_1 \Or t_2,s \symstride t_2',s''}
  [\Value(t_1',s') = \bot \land \Value(t_2',s'') = v_2]

\newrule{Sym-S-OrNone}
  {t_1,s  \symstride t_1',s'  \Quad
   t_2,s' \symstride t_2',s''}
  {t_1 \Or t_2,s \symstride t_1' \Or t_2',s''}
  [\Value(t_1',s') = \bot \land \Value(t_2',s'') = \bot]


\newrule{Sym-S-Xor}
  { }
  {e_1 \Xor e_2,s \symstride e_1 \Xor e_2,s}

\newrule{Sym-S-Eval}
    {e,s \symeval e',s'  \Quad
     e',s' \symstride e'',s''}
    {e,s \symstride e'',s''}
    [e \neq e']

%% Normalisation %%


\newmacro{RelationN}
  {e,s,p \symnormalise t,s',p'}


\newrule{Sym-N-Done}
    {e,s \symeval t,s'  \Quad
     t,s' \symstride t',s''}
    {e,s \symnormalise t',s''}
    [s'=s''\wedge t=t']

\newrule{Sym-N-Repeat}
    {e,s \symeval t,s'  \Quad
     t,s' \symstride t',s''  \Quad
     t',s'' \symnormalise t'',s'''}
    {e,s \symnormalise t'',s'''}
    [s'\neq s''\vee t\neq t']



%% Handling %%


\newmacro{RelationH}
  {t,s,pr \symhandle t',i,s',pr}

\newrule{Sym-H-Change}
  { }
  {\Edit v,s,pr \symhandle \Edit i_j,i_j,s,pr}

\newrule{Sym-H-Empty}
  { }
  {\Edit v,s,pr \symhandle \Enter \tau,\Empty,s,pr}
  [v : \tau]

\newrule{Sym-H-Fill}
  { }
  {\Enter \tau,s,pr \symhandle \Edit i_j,i_j,s,pr}

\newrule{Sym-H-Update}
  { }
  {\Update l,s,pr \symhandle \Update l,i_j,s[l \mapsto i_j],pr}


\newrule{Sym-H-PassThen}
  {t_1,s,pr \symhandle t_1',i,s',pr'}
  {t_1 \Then e_2,s,pr \symhandle t_1' \Then e_2,i,s',pr'}

\newrule{Sym-H-PassNext}
  {t_1,s,pr \symhandle t_1',i,s',pr'}
  {t_1 \Next e_2,s,pr \symhandle t_1' \Next e_2,i,s',pr'}

\newrule{Sym-H-Next}
  {e_2\ v_1,s,pr \symnormalise t_2,s',pr'}
  {t_1 \Next e_2,s,pr \symhandle t_2,\Continue,s',pr'}
  [\Value{(t_1,s)} = v_1 \wedge \neg\Failing{(t_2,s')}]


\newrule{Sym-H-FirstAnd}
  {t_1,s,pr \symhandle t_1',i,s',pr }
  {t_1 \And t_2,s,pr \symhandle t_1' \And t_2,\First i,s'pr'}

\newrule{Sym-H-SecondAnd}
  {t_2,s,pr \symhandle t_2',i,s',pr'}
  {t_1 \And t_2,s,pr \symhandle t_1 \And t_2',\Second i,s',pr'}


\newrule{Sym-H-FirstOr}
  {t_1,s,pr' \symhandle t_1',i,s',pr'}
  {t_1 \Or t_2,s,pr \symhandle t_1' \Or t_2,\First i,s',pr'}

\newrule{Sym-H-SecondOr}
  {t_2,s,pr \symhandle t_2',i,s',pr' }
  {t_1 \Or t_2,s,pr \symhandle t_1 \Or t_2',\Second i,s',pr}


\newrule{Sym-H-PickLeft}
  {e_1,s,pr \symnormalise t_1,s',pr'}
  {e_1 \Xor e_2,s,pr \symhandle t_1,\Left,s',pr'}
  [\neg\Failing(t_1,s')]

\newrule{Sym-H-PickRight}
  {e_2,s,pr \symnormalise t_2,s',pr'}
  {e_1 \Xor e_2,s,pr \symhandle t_2,\Right,s',pr'}
  [\neg\Failing(t_2,s')]

%% Driving %%


\newmacro{RelationI}
  {t,s,p \symdrive  t',i,s',p'}


\newrule{Sym-I-Handle}
  {t,s,p \symhandle t',i,s',p'  \Quad
   t',s' \symnormalise t'',s''}
  {t,s,p \symdrive t'',i,s'',p''}
